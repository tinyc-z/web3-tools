<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊâπÈáèËΩ¨Ë¥¶Â∑•ÂÖ∑ - BNB</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .wallet-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
        }

        .wallet-info {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ff;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 67, 54, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .progress-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e8ff;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .log-section {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #51cf66;
        }

        .log-entry.warning {
            color: #ffd43b;
        }

        .network-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e8ff;
        }

        .info-card h4 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .transfer-type-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: #f5f5f5;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e0e0e0;
        }

        .transfer-params {
            animation: fadeIn 0.3s ease;
        }

        .token-symbol {
            color: #667eea;
            font-weight: bold;
            margin-left: 5px;
        }

        .balance-display {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            color: #333;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .network-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ÊâπÈáèËΩ¨Ë¥¶Â∑•ÂÖ∑</h1>
            <p>Âü∫‰∫éÊô∫ËÉΩÂêàÁ∫¶ÁöÑÈ´òÊïà BSC ÊâπÈáèËΩ¨Ë¥¶Ëß£ÂÜ≥ÊñπÊ°à</p>
        </div>

        <div class="content">
            <!-- Èí±ÂåÖËøûÊé•Âå∫Âüü -->
            <div class="wallet-section">
                <button id="connectWallet" class="btn btn-primary">ü¶ä ËøûÊé• OKX Èí±ÂåÖ</button>
                

                
                <div id="walletInfo" class="wallet-info">
                    <div class="network-info">
                        <div class="info-card">
                            <h4>Èí±ÂåÖÂú∞ÂùÄ</h4>
                            <p id="walletAddress">Êú™ËøûÊé•</p>
                        </div>
                        <div class="info-card">
                            <h4>ÁΩëÁªú</h4>
                            <p id="networkName">Êú™ËøûÊé•</p>
                        </div>
                        <div class="info-card">
                            <h4>BNB ‰ΩôÈ¢ù</h4>
                            <p id="bnbBalance">0 BNB</p>
                        </div>
                        <div class="info-card" id="tokenBalanceCard" style="display: none;">
                            <h4>‰ª£Â∏Å‰ΩôÈ¢ù</h4>
                            <p id="tokenBalance">--</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ËΩ¨Ë¥¶ÂèÇÊï∞ËÆæÁΩÆ -->
            <form id="transferForm">
                <!-- ËΩ¨Ë¥¶Á±ªÂûãÈÄâÊã© -->
                <div class="form-group">
                    <label>ËΩ¨Ë¥¶Á±ªÂûã:</label>
                    <div class="transfer-type-tabs">
                        <button type="button" class="tab-button active" data-type="bnb">BNB ËΩ¨Ë¥¶</button>
                        <button type="button" class="tab-button" data-type="erc20">ERC20 ‰ª£Â∏ÅËΩ¨Ë¥¶</button>
                    </div>
                </div>

                <!-- BNB ËΩ¨Ë¥¶ÂèÇÊï∞ -->
                <div id="bnbParams" class="transfer-params">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minAmount">ÊúÄÂ∞èËΩ¨Ë¥¶ÈáëÈ¢ù (BNB)</label>
                            <input type="number" id="minAmount" step="0.0001" value="0.0001" required>
                        </div>
                        <div class="form-group">
                            <label for="maxAmount">ÊúÄÂ§ßËΩ¨Ë¥¶ÈáëÈ¢ù (BNB)</label>
                            <input type="number" id="maxAmount" step="0.0001" value="0.0001" required>
                        </div>
                    </div>
                </div>

                <!-- ERC20 ËΩ¨Ë¥¶ÂèÇÊï∞ -->
                <div id="erc20Params" class="transfer-params" style="display: none;">
                    <div class="form-group">
                        <label for="tokenSelect">ÈÄâÊã©‰ª£Â∏Å:</label>
                        <select id="tokenSelect">
                            <option value="">-- ÈÄâÊã©È¢ÑÈÖçÁΩÆ‰ª£Â∏Å --</option>
                            <option value="USDT">USDT</option>
                            <option value="ASTER">ASTER</option>
                            <option value="USDF">USDF</option>
                            <option value="custom">Ëá™ÂÆö‰πâ‰ª£Â∏ÅÂú∞ÂùÄ</option>
                        </select>
                    </div>
                    <div class="form-group" id="customTokenGroup" style="display: none;">
                        <label for="customTokenAddress">Ëá™ÂÆö‰πâ‰ª£Â∏ÅÂú∞ÂùÄ:</label>
                        <input type="text" id="customTokenAddress" placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tokenMinAmount">ÊúÄÂ∞èÈáëÈ¢ù:</label>
                            <input type="number" id="tokenMinAmount" step="0.000001" min="0" value="1" placeholder="1">
                            <span id="tokenSymbol" class="token-symbol"></span>
                        </div>
                        <div class="form-group">
                            <label for="tokenMaxAmount">ÊúÄÂ§ßÈáëÈ¢ù:</label>
                            <input type="number" id="tokenMaxAmount" step="0.000001" min="0" value="1" placeholder="1">
                            <span id="tokenSymbol2" class="token-symbol"></span>
                        </div>
                    </div>
                    <div class="form-group" id="tokenBalanceGroup" style="display: none;">
                        <label>‰ª£Â∏Å‰ΩôÈ¢ù:</label>
                        <div id="tokenBalanceDisplay" class="balance-display">--</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="batchSize">ÊØèÊâπÂ§ÑÁêÜÊï∞Èáè</label>
                    <input type="number" id="batchSize" value="200" min="1" max="500" required>
                </div>

                <div class="form-group">
                    <label for="addresses">Êé•Êî∂Âú∞ÂùÄ (ÊØèË°å‰∏Ä‰∏™Âú∞ÂùÄ)</label>
                    <textarea id="addresses" placeholder="0x1234567890123456789012345678901234567890&#10;0xabcdefabcdefabcdefabcdefabcdefabcdefabcd&#10;..." required></textarea>
                </div>

                <div class="btn-group">
                    <button type="submit" id="startTransfer" class="btn btn-success">üöÄ ÂºÄÂßãËΩ¨Ë¥¶</button>
                    <button type="button" id="stopTransfer" class="btn btn-danger" disabled>‚èπÔ∏è ÂÅúÊ≠¢ËΩ¨Ë¥¶</button>
                </div>
            </form>

            <!-- ËøõÂ∫¶ÊòæÁ§∫Âå∫Âüü -->
            <div id="progressSection" class="progress-section">
                <div class="progress-text" id="progressText">ÂáÜÂ§á‰∏≠...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="network-info">
                    <div class="info-card">
                        <h4>Â∑≤Â§ÑÁêÜ</h4>
                        <p id="processedCount">0</p>
                    </div>
                    <div class="info-card">
                        <h4>ÊÄªÊï∞Èáè</h4>
                        <p id="totalCount">0</p>
                    </div>
                    <div class="info-card">
                        <h4>ÊàêÂäüÁéá</h4>
                        <p id="successRate">0%</p>
                    </div>
                    <div class="info-card">
                        <h4>ÊÄªËä±Ë¥π</h4>
                        <p id="totalSpent">0 BNB</p>
                    </div>
                </div>
                <div id="logSection" class="log-section"></div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let provider = null;
        let signer = null;
        let contract = null;
        let isTransferring = false;
        let shouldStop = false;
        let currentTransferType = 'bnb'; // 'bnb' Êàñ 'erc20'
        let currentTokenInfo = null;

        // ÂêàÁ∫¶ÈÖçÁΩÆ
        const CONTRACT_ADDRESS = "0x1e9DEA0Fcde9d3C417D509187ef470B2739956bb";
        
        // ERC20 ‰ª£Â∏ÅÈÖçÁΩÆ (BSC ÁΩëÁªú)
        const TOKENS = {
            USDT: {
                address: "0x55d398326f99059fF775485246999027B3197955",
                symbol: "USDT",
                name: "Tether USD",
                decimals: 18
            },
            ASTER: {
                address: "0x000ae314e2a2172a039b26378814c252734f556a",
                symbol: "ASTER",
                name: "Aster Token",
                decimals: 18
            },
            USDF: {
                address: "0x5A110fC00474038f6c02E89C707D638602EA44B5",
                symbol: "USDF",
                name: "USDF Token",
                decimals: 18
            }
        };

        // ERC20 ABI
        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {"internalType": "address[]", "name": "recipients", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}
                ],
                "name": "batchTransfer",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token", "type": "address"},
                    {"internalType": "address[]", "name": "recipients", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}
                ],
                "name": "batchTransferERC20",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address payable", "name": "to", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "emergencyWithdrawNative",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token", "type": "address"},
                    {"internalType": "address", "name": "to", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "emergencyWithdrawToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];

        // ÁΩëÁªúÈÖçÁΩÆ
        const NETWORKS = {
            56: {
                name: 'BSC Mainnet',
                symbol: 'BNB',
                rpcUrl: 'https://bsc-dataseed1.binance.org/',
                blockExplorerUrl: 'https://bscscan.com'
            }
        };

        // DOM ÂÖÉÁ¥†
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const networkName = document.getElementById('networkName');
        const walletBalance = document.getElementById('walletBalance');
        const transferForm = document.getElementById('transferForm');
        const startTransferBtn = document.getElementById('startTransfer');
        const stopTransferBtn = document.getElementById('stopTransfer');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const logSection = document.getElementById('logSection');

        // Êó•ÂøóÂáΩÊï∞
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logSection.appendChild(logEntry);
            logSection.scrollTop = logSection.scrollHeight;
        }

        // ËøûÊé•Èí±ÂåÖ
        async function connectWallet() {
            try {
                // Ê£ÄÊµãÂ§öÁßçÈí±ÂåÖÊèê‰æõËÄÖ
                let walletProvider = null;
                let walletName = '';

                // Ê£ÄÊµã OKX Èí±ÂåÖÁöÑÂ§öÁßçÂèØËÉΩÊñπÂºè
                if (typeof window.okxwallet !== 'undefined') {
                    walletProvider = window.okxwallet;
                    walletName = 'OKX';
                } else if (typeof window.okex !== 'undefined' && window.okex.ethereum) {
                    walletProvider = window.okex.ethereum;
                    walletName = 'OKX';
                } else if (typeof window.ethereum !== 'undefined') {
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ OKX Èí±ÂåÖ
                    if (window.ethereum.isOkxWallet || window.ethereum.isOKExWallet) {
                        walletProvider = window.ethereum;
                        walletName = 'OKX';
                    } else {
                        // Â∞ùËØï‰ΩøÁî®ÈÄöÁî®ÁöÑ ethereum Êèê‰æõËÄÖ
                        walletProvider = window.ethereum;
                        walletName = 'Web3';
                    }
                }

                if (!walletProvider) {
                    alert('Êú™Ê£ÄÊµãÂà∞Èí±ÂåÖÊâ©Â±ïÔºåËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö OKX Èí±ÂåÖÊàñÂÖ∂‰ªñ Web3 Èí±ÂåÖ');
                    return;
                }

                addLog(`Ê£ÄÊµãÂà∞ ${walletName} Èí±ÂåÖ`, 'info');

                // ËØ∑Ê±ÇËøûÊé•Èí±ÂåÖ
                const accounts = await walletProvider.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('Êú™Ëé∑ÂèñÂà∞Èí±ÂåÖË¥¶Êà∑');
                }

                // ÂàõÂª∫ provider Âíå signer
                provider = new ethers.BrowserProvider(walletProvider);
                signer = await provider.getSigner();

                // Ëé∑ÂèñÁΩëÁªú‰ø°ÊÅØ
                const network = await provider.getNetwork();
                const chainId = Number(network.chainId);

                // Ê£ÄÊü•ÊòØÂê¶‰∏∫ BSC ÁΩëÁªú
                if (chainId !== 56) {
                    try {
                        await walletProvider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }], // BSC Mainnet
                        });
                        // ÈáçÊñ∞Ëé∑ÂèñÁΩëÁªú‰ø°ÊÅØ
                        const newNetwork = await provider.getNetwork();
                        const newChainId = Number(newNetwork.chainId);
                        if (newChainId !== 56) {
                            throw new Error('ËØ∑ÂàáÊç¢Âà∞ BSC ‰∏ªÁΩë');
                        }
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            // ÁΩëÁªú‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÊ∑ªÂä† BSC ÁΩëÁªú
                            try {
                                await walletProvider.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x38',
                                        chainName: 'BSC Mainnet',
                                        nativeCurrency: {
                                            name: 'BNB',
                                            symbol: 'BNB',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://bsc-dataseed1.binance.org/'],
                                        blockExplorerUrls: ['https://bscscan.com/']
                                    }]
                                });
                            } catch (addError) {
                                throw new Error('ËØ∑ÊâãÂä®Ê∑ªÂä†Âπ∂ÂàáÊç¢Âà∞ BSC ‰∏ªÁΩë');
                            }
                        } else {
                            throw new Error('ËØ∑ÊâãÂä®ÂàáÊç¢Âà∞ BSC ‰∏ªÁΩë');
                        }
                    }
                }

                // Ëé∑Âèñ‰ΩôÈ¢ù
                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);

                // ÂàõÂª∫ÂêàÁ∫¶ÂÆû‰æã
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Êõ¥Êñ∞ UI
                document.getElementById('walletAddress').textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;
                document.getElementById('networkName').textContent = NETWORKS[chainId]?.name || `Chain ID: ${chainId}`;
                document.getElementById('bnbBalance').textContent = `${ethers.formatEther(balance)} BNB`;
                
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectWallet').textContent = `‚úÖ ${walletName} Èí±ÂåÖÂ∑≤ËøûÊé•`;
                document.getElementById('connectWallet').disabled = true;

                // Â¶ÇÊûúÂ∑≤ÈÄâÊã©‰ª£Â∏ÅÔºåÊõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ù
                if (currentTokenInfo) {
                    await updateTokenBalance();
                    // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞
                    startBalanceUpdates();
                }

                addLog(`${walletName} Èí±ÂåÖËøûÊé•ÊàêÂäü`, 'success');
                addLog(`Âú∞ÂùÄ: ${address}`, 'info');
                addLog(`‰ΩôÈ¢ù: ${ethers.formatEther(balance)} BNB`, 'info');

                // ËÆæÁΩÆÈí±ÂåÖ‰∫ã‰ª∂ÁõëÂê¨
                if (walletProvider.on) {
                    walletProvider.on('accountsChanged', handleAccountsChanged);
                    walletProvider.on('chainChanged', handleChainChanged);
                }

            } catch (error) {
                console.error('ËøûÊé•Èí±ÂåÖÂ§±Ë¥•:', error);
                addLog(`ËøûÊé•Èí±ÂåÖÂ§±Ë¥•: ${error.message}`, 'error');
                alert(`ËøûÊé•Èí±ÂåÖÂ§±Ë¥•: ${error.message}`);
            }
        }

        // Â§ÑÁêÜË¥¶Êà∑ÂèòÂåñ
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // Èí±ÂåÖÊñ≠ÂºÄËøûÊé•
                document.getElementById('walletInfo').style.display = 'none';
                document.getElementById('connectWallet').textContent = 'ü¶ä ËøûÊé•Èí±ÂåÖ';
                document.getElementById('connectWallet').disabled = false;
                provider = null;
                signer = null;
                contract = null;
                
                // ÂÅúÊ≠¢‰ΩôÈ¢ùÊõ¥Êñ∞
                stopBalanceUpdates();
                
                addLog('Èí±ÂåÖÂ∑≤Êñ≠ÂºÄËøûÊé•', 'warning');
            } else {
                // Ë¥¶Êà∑ÂàáÊç¢ÔºåÈáçÊñ∞ËøûÊé•
                addLog('Ê£ÄÊµãÂà∞Ë¥¶Êà∑ÂàáÊç¢ÔºåÈáçÊñ∞ËøûÊé•Èí±ÂåÖ...', 'info');
                connectWallet();
            }
        }

        // Â§ÑÁêÜÁΩëÁªúÂèòÂåñ
        function handleChainChanged(chainId) {
            // ÁΩëÁªúÂàáÊç¢ÔºåÈáçÊñ∞ËøûÊé•
            addLog('Ê£ÄÊµãÂà∞ÁΩëÁªúÂàáÊç¢ÔºåÈáçÊñ∞ËøûÊé•Èí±ÂåÖ...', 'info');
            connectWallet();
        }

        // Ëß£ÊûêÂú∞ÂùÄÂàóË°®
        function parseAddresses(addressText) {
            return addressText
                .split('\n')
                .map(addr => addr.trim())
                .filter(addr => addr && ethers.isAddress(addr));
        }

        // ÁîüÊàêËΩ¨Ë¥¶ÈáëÈ¢ù
        function generateAmount(minAmount, maxAmount) {
            if (minAmount === maxAmount) {
                return ethers.parseEther(minAmount.toString());
            } else {
                const randomValue = Math.random() * (maxAmount - minAmount) + minAmount;
                return ethers.parseEther(randomValue.toFixed(8));
            }
        }

        // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
        async function updateBalances() {
            if (!signer) return;
            
            try {
                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);
                document.getElementById('bnbBalance').textContent = `${ethers.formatEther(balance)} BNB`;
            } catch (error) {
                console.error('Ëé∑ÂèñBNB‰ΩôÈ¢ùÂ§±Ë¥•:', error);
                document.getElementById('bnbBalance').textContent = 'Ëé∑ÂèñÂ§±Ë¥•';
            }
        }

        // Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ù
        async function updateTokenBalance() {
            if (!signer || !currentTokenInfo) return;
            
            try {
                const address = await signer.getAddress();
                const tokenContract = new ethers.Contract(currentTokenInfo.address, ERC20_ABI, provider);
                const balance = await tokenContract.balanceOf(address);
                const formattedBalance = ethers.formatUnits(balance, currentTokenInfo.decimals);
                
                document.getElementById('tokenBalance').textContent = `${formattedBalance} ${currentTokenInfo.symbol}`;
            } catch (error) {
                console.error('Ëé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ùÂ§±Ë¥•:', error);
                document.getElementById('tokenBalance').textContent = 'Ëé∑ÂèñÂ§±Ë¥•';
            }
        }

        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress(processed, total, successCount, totalSpent, tokenSymbol = 'BNB') {
            const percentage = total > 0 ? (processed / total) * 100 : 0;
            const successRate = processed > 0 ? (successCount / processed) * 100 : 0;

            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `Â§ÑÁêÜËøõÂ∫¶: ${processed}/${total} (${percentage.toFixed(1)}%)`;
            
            document.getElementById('processedCount').textContent = processed;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
            
            // ‰øÆÂ§çBigIntËΩ¨Êç¢ÈóÆÈ¢ò
            let spentFormatted;
            if (typeof totalSpent === 'bigint') {
                spentFormatted = tokenSymbol === 'BNB' ? 
                    ethers.formatEther(totalSpent) : 
                    ethers.formatUnits(totalSpent, currentTokenInfo?.decimals || 18);
            } else {
                spentFormatted = totalSpent.toString();
            }
            
            document.getElementById('totalSpent').textContent = `${spentFormatted} ${tokenSymbol}`;
        }

        // ÈöèÊú∫Âª∂Ëøü
        function randomDelay(min = 3000, max = 5000) {
            const delay = Math.floor(Math.random() * (max - min + 1)) + min;
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        // ÂºÄÂßãÊâπÈáèËΩ¨Ë¥¶
        async function startBatchTransfer() {
            if (!signer || !contract) {
                alert('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ');
                return;
            }

            try {
                // Ê†πÊçÆËΩ¨Ë¥¶Á±ªÂûãÊâßË°å‰∏çÂêåÈÄªËæë
                if (currentTransferType === 'bnb') {
                    await startBNBTransfer();
                } else {
                    await startERC20Transfer();
                }

            } catch (error) {
                console.error('ÊâπÈáèËΩ¨Ë¥¶Â§±Ë¥•:', error);
                addLog(`ÊâπÈáèËΩ¨Ë¥¶Â§±Ë¥•: ${error.message}`, 'error');
                alert(`ÊâπÈáèËΩ¨Ë¥¶Â§±Ë¥•: ${error.message}`);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isTransferring = false;
                shouldStop = false;
                document.getElementById('startTransfer').disabled = false;
                document.getElementById('stopTransfer').disabled = true;
            }
        }

        // BNB ËΩ¨Ë¥¶ÈÄªËæë
        async function startBNBTransfer() {
            // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
            const minAmount = parseFloat(document.getElementById('minAmount').value);
            const maxAmount = parseFloat(document.getElementById('maxAmount').value);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const addressText = document.getElementById('addresses').value;

            // È™åËØÅËæìÂÖ•
            if (minAmount <= 0 || maxAmount <= 0 || minAmount > maxAmount) {
                throw new Error('ËΩ¨Ë¥¶ÈáëÈ¢ùËÆæÁΩÆÊó†Êïà');
            }

            if (batchSize <= 0 || batchSize > 500) {
                throw new Error('ÊâπÊ¨°Â§ßÂ∞èÂøÖÈ°ªÂú® 1-500 ‰πãÈó¥');
            }

            // Ëß£ÊûêÂú∞ÂùÄ
            const addresses = parseAddresses(addressText);
            if (addresses.length === 0) {
                throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊé•Êî∂Âú∞ÂùÄ');
            }

            // ËÆæÁΩÆÁä∂ÊÄÅ
            isTransferring = true;
            shouldStop = false;
            document.getElementById('startTransfer').disabled = true;
            document.getElementById('stopTransfer').disabled = false;
            document.getElementById('progressSection').style.display = 'block';

            addLog(`ÂºÄÂßãÊâπÈáèËΩ¨Ë¥¶ÔºåÂÖ± ${addresses.length} ‰∏™Âú∞ÂùÄ`, 'info');
            addLog(`ËΩ¨Ë¥¶ÈáëÈ¢ùËåÉÂõ¥: ${minAmount} - ${maxAmount} BNB`, 'info');
            addLog(`ÊâπÊ¨°Â§ßÂ∞è: ${batchSize}`, 'info');

            let totalProcessed = 0;
            let totalSuccess = 0;
            let totalSpent = 0n;

            // ÂàÜÊâπÂ§ÑÁêÜ
            for (let i = 0; i < addresses.length && !shouldStop; i += batchSize) {
                const batch = addresses.slice(i, i + batchSize);
                const batchNumber = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(addresses.length / batchSize);

                addLog(`Â§ÑÁêÜÁ¨¨ ${batchNumber}/${totalBatches} ÊâπÔºåÂÖ± ${batch.length} ‰∏™Âú∞ÂùÄ`, 'info');

                // ÁîüÊàêÈáëÈ¢ùÊï∞ÁªÑ
                const amounts = batch.map(() => generateAmount(minAmount, maxAmount));
                const totalNeeded = amounts.reduce((sum, amount) => sum + amount, 0n);

                addLog(`Á¨¨ ${batchNumber} ÊâπÊÄªÈáëÈ¢ù: ${ethers.formatEther(totalNeeded)} BNB`, 'info');

                try {
                    // Ëé∑Âèñ gas ‰ø°ÊÅØ
                    const feeData = await provider.getFeeData();
                    const gasPrice = feeData.gasPrice;

                    // ‰º∞ÁÆó gas
                    const estimatedGas = await contract.batchTransfer.estimateGas(batch, amounts, {
                        value: totalNeeded
                    });
                    const gasLimit = estimatedGas * 120n / 100n; // Â¢ûÂä†20%ÁºìÂÜ≤

                    addLog(`È¢Ñ‰º∞ Gas: ${estimatedGas.toString()}, Gas Price: ${ethers.formatUnits(gasPrice, 'gwei')} Gwei`, 'info');

                    // ÂèëÈÄÅ‰∫§Êòì
                    const tx = await contract.batchTransfer(batch, amounts, {
                        value: totalNeeded,
                        gasLimit: gasLimit,
                        gasPrice: gasPrice
                    });

                    addLog(`‚è≥ Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÂ∑≤ÂèëÈÄÅ: ${tx.hash}`, 'info');

                    // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                    const receipt = await tx.wait();

                    if (receipt.status === 1) {
                        addLog(`‚úÖ Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÊàêÂäü: https://bscscan.com/tx/${tx.hash}`, 'success');
                        totalSuccess += batch.length;
                        totalSpent += totalNeeded;
                    } else {
                        addLog(`‚ùå Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÂ§±Ë¥•`, 'error');
                    }

                } catch (error) {
                    addLog(`‚ùå Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÂ§±Ë¥•: ${error.message}`, 'error');
                }

                totalProcessed += batch.length;
                // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
                updateProgress(totalProcessed, addresses.length, totalSuccess, totalSpent, currentTransferType === 'bnb' ? 'BNB' : currentTokenInfo.symbol);

                // ÈöèÊú∫Âª∂Ëøü
                if (i + batchSize < addresses.length && !shouldStop) {
                    addLog('Á≠âÂæÖÈöèÊú∫Âª∂Ëøü...', 'info');
                    await randomDelay();
                }
            }

            if (shouldStop) {
                addLog('ËΩ¨Ë¥¶Â∑≤Ë¢´Áî®Êà∑ÂÅúÊ≠¢', 'warning');
            } else {
                addLog(`‚úÖ ÊâπÈáèËΩ¨Ë¥¶ÂÆåÊàêÔºÅÊÄªÂÖ±Â§ÑÁêÜ ${totalProcessed} ‰∏™Âú∞ÂùÄÔºåÊàêÂäü ${totalSuccess} ‰∏™ÔºåÂÖ±Ëä±Ë¥π ${ethers.formatEther(totalSpent)} BNB`, 'success');
                // ËΩ¨Ë¥¶ÂÆåÊàêÂêéÊõ¥Êñ∞‰ΩôÈ¢ù
                await onTransferComplete();
            }
        }

        // ERC20 ËΩ¨Ë¥¶ÈÄªËæë
        async function startERC20Transfer() {
            // È™åËØÅ‰ª£Â∏Å‰ø°ÊÅØ
            if (!currentTokenInfo) {
                throw new Error('ËØ∑ÂÖàÈÄâÊã©‰ª£Â∏Å');
            }

            const minAmount = parseFloat(document.getElementById('tokenMinAmount').value);
            const maxAmount = parseFloat(document.getElementById('tokenMaxAmount').value);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const addressText = document.getElementById('addresses').value;

            // È™åËØÅËæìÂÖ•
            if (minAmount <= 0 || maxAmount <= 0 || minAmount > maxAmount) {
                throw new Error('ËΩ¨Ë¥¶ÈáëÈ¢ùËÆæÁΩÆÊó†Êïà');
            }

            if (batchSize <= 0 || batchSize > 500) {
                throw new Error('ÊâπÊ¨°Â§ßÂ∞èÂøÖÈ°ªÂú® 1-500 ‰πãÈó¥');
            }

            // Ëß£ÊûêÂú∞ÂùÄ
            const addresses = parseAddresses(addressText);
            if (addresses.length === 0) {
                throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊé•Êî∂Âú∞ÂùÄ');
            }

            // ËÆæÁΩÆÁä∂ÊÄÅ
            isTransferring = true;
            shouldStop = false;
            document.getElementById('startTransfer').disabled = true;
            document.getElementById('stopTransfer').disabled = false;
            document.getElementById('progressSection').style.display = 'block';

            addLog(`ÂºÄÂßãÊâπÈáèËΩ¨Ë¥¶ ${currentTokenInfo.symbol}ÔºåÂÖ± ${addresses.length} ‰∏™Âú∞ÂùÄ`, 'info');
            addLog(`ËΩ¨Ë¥¶ÈáëÈ¢ùËåÉÂõ¥: ${minAmount} - ${maxAmount} ${currentTokenInfo.symbol}`, 'info');
            addLog(`ÊâπÊ¨°Â§ßÂ∞è: ${batchSize}`, 'info');

            // Ê£ÄÊü•ÊéàÊùÉ
            const userAddress = await signer.getAddress();
            const allowance = await currentTokenInfo.contract.allowance(userAddress, CONTRACT_ADDRESS);
            const totalNeeded = ethers.parseUnits((maxAmount * addresses.length).toString(), currentTokenInfo.decimals);

            addLog(`Ê£ÄÊü•‰ª£Â∏ÅÊéàÊùÉ: ÂΩìÂâçÊéàÊùÉ ${ethers.formatUnits(allowance, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}`, 'info');
            addLog(`ÈúÄË¶ÅÊéàÊùÉ: ${ethers.formatUnits(totalNeeded, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}`, 'info');

            if (allowance < totalNeeded) {
                addLog('ÊéàÊùÉÈ¢ùÂ∫¶‰∏çË∂≥ÔºåÈúÄË¶ÅÊéàÊùÉ‰ª£Â∏Å‰ΩøÁî®ÊùÉÈôê...', 'warning');
                try {
                    const tokenContract = new ethers.Contract(currentTokenInfo.address, ERC20_ABI, signer);
                    
                    // ÂÖàÊ£ÄÊü•ÂΩìÂâç‰ΩôÈ¢ù
                    const balance = await tokenContract.balanceOf(userAddress);
                    addLog(`ÂΩìÂâç‰ª£Â∏Å‰ΩôÈ¢ù: ${ethers.formatUnits(balance, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}`, 'info');
                    
                    if (balance < totalNeeded) {
                        throw new Error(`‰ª£Â∏Å‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÈúÄË¶Å ${ethers.formatUnits(totalNeeded, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}ÔºåÂΩìÂâçÂè™Êúâ ${ethers.formatUnits(balance, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}`);
                    }
                    
                    addLog('ÂèëÈÄÅÊéàÊùÉ‰∫§Êòì...', 'info');
                    const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
                    addLog(`ÊéàÊùÉ‰∫§ÊòìÂ∑≤ÂèëÈÄÅ: ${approveTx.hash}`, 'info');
                    addLog('Á≠âÂæÖÊéàÊùÉ‰∫§ÊòìÁ°ÆËÆ§...', 'info');
                    await approveTx.wait();
                    addLog('‚úÖ ÊéàÊùÉÊàêÂäü', 'success');
                } catch (error) {
                    throw new Error(`ÊéàÊùÉÂ§±Ë¥•: ${error.message}`);
                }
            } else {
                addLog('‚úÖ ÊéàÊùÉÈ¢ùÂ∫¶ÂÖÖË∂≥ÔºåÊó†ÈúÄÈáçÊñ∞ÊéàÊùÉ', 'success');
            }

            let totalProcessed = 0;
            let totalSuccess = 0;
            let totalSpent = 0n;

            // ÂàÜÊâπÂ§ÑÁêÜ
            for (let i = 0; i < addresses.length && !shouldStop; i += batchSize) {
                const batch = addresses.slice(i, i + batchSize);
                const batchNumber = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(addresses.length / batchSize);

                addLog(`Â§ÑÁêÜÁ¨¨ ${batchNumber}/${totalBatches} ÊâπÔºåÂÖ± ${batch.length} ‰∏™Âú∞ÂùÄ`, 'info');

                // ÁîüÊàêÈáëÈ¢ùÊï∞ÁªÑ
                const amounts = batch.map(() => {
                    const randomValue = Math.random() * (maxAmount - minAmount) + minAmount;
                    return ethers.parseUnits(randomValue.toFixed(Math.min(currentTokenInfo.decimals, 18)), currentTokenInfo.decimals);
                });
                const batchTotal = amounts.reduce((sum, amount) => sum + amount, 0n);

                addLog(`Á¨¨ ${batchNumber} ÊâπÊÄªÈáëÈ¢ù: ${ethers.formatUnits(batchTotal, currentTokenInfo.decimals)} ${currentTokenInfo.symbol}`, 'info');

                try {
                    // Ë∞ÉÁî®ÂêàÁ∫¶ÁöÑbatchTransferERC20ÂáΩÊï∞
                    addLog(`ÂèëÈÄÅÁ¨¨ ${batchNumber} ÊâπERC20ËΩ¨Ë¥¶‰∫§Êòì...`, 'info');
                    
                    const tx = await contract.batchTransferERC20(
                        currentTokenInfo.address,
                        batch,
                        amounts,
                        {
                            gasLimit: 500000 + (batch.length * 50000) // Âä®ÊÄÅËÆ°ÁÆógasÈôêÂà∂
                        }
                    );
                    
                    addLog(`‰∫§ÊòìÂ∑≤ÂèëÈÄÅ: ${tx.hash}`, 'info');
                    addLog('Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...', 'info');
                    
                    const receipt = await tx.wait();
                    
                    if (receipt.status === 1) {
                        addLog(`‚úÖ Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÊàêÂäüÔºåGas‰ΩøÁî®: ${receipt.gasUsed.toString()}`, 'success');
                        totalSuccess += batch.length;
                        totalSpent += batchTotal;
                    } else {
                        addLog(`‚ùå Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÂ§±Ë¥•`, 'error');
                    }

                } catch (error) {
                    addLog(`‚ùå Á¨¨ ${batchNumber} Êâπ‰∫§ÊòìÂ§±Ë¥•: ${error.message}`, 'error');
                    
                    // Â¶ÇÊûúÊòØgas‰º∞ÁÆóÂ§±Ë¥•ÔºåÂ∞ùËØïÈôç‰ΩéÊâπÊ¨°Â§ßÂ∞è
                    if (error.message.includes('gas') || error.message.includes('Gas')) {
                        addLog('Âª∫ËÆÆÂáèÂ∞ëÊâπÊ¨°Â§ßÂ∞èÈáçËØï', 'warning');
                    }
                }

                totalProcessed += batch.length;
                 updateProgress(totalProcessed, addresses.length, totalSuccess, totalSpent, currentTransferType === 'bnb' ? 'BNB' : currentTokenInfo.symbol);

                // ÈöèÊú∫Âª∂Ëøü
                if (i + batchSize < addresses.length && !shouldStop) {
                    addLog('Á≠âÂæÖÈöèÊú∫Âª∂Ëøü...', 'info');
                    await randomDelay();
                }
            }

            if (shouldStop) {
                addLog('ËΩ¨Ë¥¶Â∑≤Ë¢´Áî®Êà∑ÂÅúÊ≠¢', 'warning');
            } else {
                addLog(`ERC20ÊâπÈáèËΩ¨Ë¥¶ÂÆåÊàêÔºÅÊÄªÂÖ±Â§ÑÁêÜ ${totalProcessed} ‰∏™Âú∞ÂùÄÔºåÊàêÂäü ${totalSuccess} ‰∏™`, 'success');
                // ËΩ¨Ë¥¶ÂÆåÊàêÂêéÊõ¥Êñ∞‰ΩôÈ¢ù
                await onTransferComplete();
            }
        }

        // ÂÅúÊ≠¢ËΩ¨Ë¥¶
        function stopTransfer() {
            if (isTransferring) {
                shouldStop = true;
                addLog('Ê≠£Âú®ÂÅúÊ≠¢ËΩ¨Ë¥¶...', 'warning');
                document.getElementById('stopTransfer').disabled = true;
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('transferForm').addEventListener('submit', (e) => {
            e.preventDefault();
            startBatchTransfer();
        });
        document.getElementById('stopTransfer').addEventListener('click', stopTransfer);

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('load', async () => {
            // ÂàùÂßãÂåñËΩ¨Ë¥¶Á±ªÂûãÂàáÊç¢
            initTransferTypeTabs();
            
            // ÂàùÂßãÂåñ‰ª£Â∏ÅÈÄâÊã©
            initTokenSelection();
            
            // Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅ
            checkWalletConnection();
        });

        // Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅ
        async function checkWalletConnection() {
            // Ê£ÄÊµãÂ§öÁßçÈí±ÂåÖÊèê‰æõËÄÖ
            let walletProvider = null;
            
            if (typeof window.okxwallet !== 'undefined') {
                walletProvider = window.okxwallet;
            } else if (typeof window.okex !== 'undefined' && window.okex.ethereum) {
                walletProvider = window.okex.ethereum;
            } else if (typeof window.ethereum !== 'undefined') {
                walletProvider = window.ethereum;
            }

            if (walletProvider) {
                try {
                    const accounts = await walletProvider.request({
                        method: 'eth_accounts'
                    });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.log('Ëá™Âä®ËøûÊé•Èí±ÂåÖÂ§±Ë¥•:', error);
                }
            }
        }

        // ÂàùÂßãÂåñËΩ¨Ë¥¶Á±ªÂûãÂàáÊç¢
        function initTransferTypeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const bnbParams = document.getElementById('bnbParams');
            const erc20Params = document.getElementById('erc20Params');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.dataset.type;
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ÂàáÊç¢ÂèÇÊï∞Èù¢Êùø
                    if (type === 'bnb') {
                        bnbParams.style.display = 'block';
                        erc20Params.style.display = 'none';
                        currentTransferType = 'bnb';
                    } else {
                        bnbParams.style.display = 'none';
                        erc20Params.style.display = 'block';
                        currentTransferType = 'erc20';
                    }
                    
                    // ÊòæÁ§∫/ÈöêËóè‰ª£Â∏Å‰ΩôÈ¢ùÂç°Áâá
                    const tokenBalanceCard = document.getElementById('tokenBalanceCard');
                    if (currentTransferType === 'erc20' && currentTokenInfo) {
                        tokenBalanceCard.style.display = 'block';
                    } else {
                        tokenBalanceCard.style.display = 'none';
                    }
                });
            });
        }

        // ÂàùÂßãÂåñ‰ª£Â∏ÅÈÄâÊã©
        function initTokenSelection() {
            const tokenSelect = document.getElementById('tokenSelect');
            const customTokenGroup = document.getElementById('customTokenGroup');
            const customTokenAddress = document.getElementById('customTokenAddress');

            tokenSelect.addEventListener('change', async function() {
                const selectedToken = this.value;
                
                if (selectedToken === 'custom') {
                    customTokenGroup.style.display = 'block';
                    currentTokenInfo = null;
                    updateTokenSymbols('');
                } else if (selectedToken === '') {
                    customTokenGroup.style.display = 'none';
                    currentTokenInfo = null;
                    updateTokenSymbols('');
                    hideTokenBalance();
                } else {
                    customTokenGroup.style.display = 'none';
                    await loadTokenInfo(TOKENS[selectedToken].address);
                }
            });

            customTokenAddress.addEventListener('blur', async function() {
                const address = this.value.trim();
                if (address && ethers.isAddress(address)) {
                    await loadTokenInfo(address);
                }
            });
        }

        // Âä†ËΩΩ‰ª£Â∏Å‰ø°ÊÅØ
        async function loadTokenInfo(tokenAddress) {
            if (!provider) {
                addLog('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'warning');
                return;
            }

            try {
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                
                const [symbol, decimals, name] = await Promise.all([
                    tokenContract.symbol(),
                    tokenContract.decimals(),
                    tokenContract.name()
                ]);

                currentTokenInfo = {
                    address: tokenAddress,
                    symbol,
                    decimals: Number(decimals), // Á°Æ‰øùdecimalsÊòØÊï∞Â≠óÁ±ªÂûã
                    name,
                    contract: tokenContract
                };

                updateTokenSymbols(symbol);
                
                // ÊòæÁ§∫‰ª£Â∏Å‰ΩôÈ¢ùÁªÑ
                    document.getElementById('tokenBalanceGroup').style.display = 'block';
                    
                    // ÊòæÁ§∫‰ª£Â∏Å‰ΩôÈ¢ùÂç°Áâá
                    document.getElementById('tokenBalanceCard').style.display = 'block';
                    
                    // Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ùÊòæÁ§∫
                    if (signer) {
                        await updateTokenBalance();
                        // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞
                        startBalanceUpdates();
                    }
                
                // ÊòæÁ§∫‰ª£Â∏Å‰ΩôÈ¢ùÁªÑ
                    document.getElementById('tokenBalanceGroup').style.display = 'block';
                    
                    // ÊòæÁ§∫‰ª£Â∏Å‰ΩôÈ¢ùÂç°Áâá
                    document.getElementById('tokenBalanceCard').style.display = 'block';
                    
                    // Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ùÊòæÁ§∫
                    if (signer) {
                        await updateTokenBalance();
                        // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞
                        startBalanceUpdates();
                    }
                    
                    addLog(`‰ª£Â∏Å‰ø°ÊÅØÂä†ËΩΩÊàêÂäü: ${name} (${symbol})`, 'success');
            } catch (error) {
                addLog(`Âä†ËΩΩ‰ª£Â∏Å‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`, 'error');
                currentTokenInfo = null;
                updateTokenSymbols('');
                hideTokenBalance();
            }
        }

        // Êõ¥Êñ∞‰ª£Â∏ÅÁ¨¶Âè∑ÊòæÁ§∫
        function updateTokenSymbols(symbol) {
            document.getElementById('tokenSymbol').textContent = symbol;
            document.getElementById('tokenSymbol2').textContent = symbol;
        }

        // Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ù
        async function updateTokenBalance() {
            if (!currentTokenInfo || !signer) {
                hideTokenBalance();
                return;
            }

            try {
                const address = await signer.getAddress();
                const balance = await currentTokenInfo.contract.balanceOf(address);
                const formattedBalance = ethers.formatUnits(balance, currentTokenInfo.decimals);
                
                document.getElementById('tokenBalance').textContent = `${formattedBalance} ${currentTokenInfo.symbol}`;
                document.getElementById('tokenBalanceDisplay').textContent = `${formattedBalance} ${currentTokenInfo.symbol}`;
                document.getElementById('tokenBalanceGroup').style.display = 'block';
                
                // Ê∑ªÂä†Âà∑Êñ∞Êó∂Èó¥ÊòæÁ§∫
                const now = new Date().toLocaleTimeString();
                console.log(`‰ª£Â∏Å‰ΩôÈ¢ùÂ∑≤Êõ¥Êñ∞ (${now}): ${formattedBalance} ${currentTokenInfo.symbol}`);
            } catch (error) {
                addLog(`Ëé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ùÂ§±Ë¥•: ${error.message}`, 'error');
                hideTokenBalance();
            }
        }

        // ÂÆöÊó∂Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ù
        let balanceUpdateInterval = null;
        
        function startBalanceUpdates() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑÂÆöÊó∂Âô®
            if (balanceUpdateInterval) {
                clearInterval(balanceUpdateInterval);
            }
            
            // ÊØè30ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°‰ΩôÈ¢ù
            balanceUpdateInterval = setInterval(async () => {
                if (currentTokenInfo && signer) {
                    await updateTokenBalance();
                }
            }, 30000);
        }
        
        function stopBalanceUpdates() {
            if (balanceUpdateInterval) {
                clearInterval(balanceUpdateInterval);
                balanceUpdateInterval = null;
            }
        }

        // Âú®ÊâπÈáèËΩ¨Ë¥¶ÂÆåÊàêÂêéÊõ¥Êñ∞‰ΩôÈ¢ù
        async function onTransferComplete() {
            // Êõ¥Êñ∞‰ª£Â∏Å‰ΩôÈ¢ù
            if (currentTokenInfo && signer) {
                await updateTokenBalance();
                addLog('‰ª£Â∏Å‰ΩôÈ¢ùÂ∑≤Êõ¥Êñ∞', 'info');
            }
        }

        // ÈöêËóè‰ª£Â∏Å‰ΩôÈ¢ù
        function hideTokenBalance() {
            document.getElementById('tokenBalanceGroup').style.display = 'none';
        }

        // ÁõëÂê¨Ë¥¶Êà∑ÂèòÂåñ - ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÂõ†‰∏∫Â∑≤Âú® connectWallet ‰∏≠Â§ÑÁêÜ
    </script>
</body>
</html>